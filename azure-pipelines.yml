trigger: none
#  branches:
#     include:
#       - main
#       - feature/*

pool: 
 name: Agent

stages:
  # - stage: Buildstage
  #   displayName: Build stage ban raha hai
  #   jobs:
  #     - job: nodeinstalljob
  #       displayName: nodewa install ho raha hai
  #       steps:
  #       - task: NodeTool@0  #node_module folder create hota hai
  #         displayName: nodewa install ho raha hai
  #         inputs:
  #           versionSource: 'spec'
  #           versionSpec: '16.x'
  #           checkLatest: true
  
  #       - task: Npm@1
  #         displayName: npm install
  #         inputs:
  #           command: 'install'
  #           workingDir: '$(System.DefaultWorkingDirectory)'
        
  #       - task: Npm@1
  #         displayName: npm build #agent pe build folder banega
  #         inputs:
  #           command: 'custom'
  #           workingDir: '$(System.DefaultWorkingDirectory)'
  #           customCommand: 'run build'

  #       - task: PublishBuildArtifacts@1
  #         inputs:
  #           PathtoPublish: '$(Build.ArtifactStagingDirectory)'
  #           ArtifactName: 'todo'
  #           publishLocation: 'FilePath'
  #           TargetPath: '$(Build.ArtifactStagingDirectory)/build'

  - stage: Deploy   #Artifact Download kar rahe hai
    displayName: Deploy todo
    jobs:
      - job: Deplotodo
        steps:
        - task: DownloadBuildArtifacts@1
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: 'todo'
            downloadPath: '$(System.ArtifactsDirectory)'
            

        - task: CopyFilesOverSSH@0 # Artifact ko copy karke VM mai dal rahe hai through copyssh
          inputs:
            sshEndpoint: 'VMtodo'
            sourceFolder: '$(Build.ArtifactStagingDirectory)/build'
            contents: '**'
            targetFolder: '/home/adminuser1/todoapp'
            cleanTargetFolder: true
            readyTimeout: '20000'
        - task: SSH@0
          inputs:
            sshEndpoint: 'VMtodo'
            runOptions: 'commands'
            commands: 'sudo cp -r /home/adminuser1/todoapp/ * var/www/html'
            readyTimeout: '20000'
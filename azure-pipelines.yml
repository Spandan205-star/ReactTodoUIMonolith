trigger: none

pool: Default

stages:
  - stage: CI
    displayName: CI Stage
    jobs:
      - job: nodeInstall 
        displayName: Node installation 
        steps:
        - task: NodeTool@0
          inputs:
            versionSource: 'spec'
            versionSpec: '17.x'

      - job: npmInstall
        dependsOn: nodeInstall
        displayName: Npm Install
        steps:
        - task: PowerShell@2
          inputs:
            targetType: 'inline'
            script: 'npm install'
            
      
      - job: npmbuild
        dependsOn: npmInstall
        displayName: npm build
        steps:
        - task: PowerShell@2
          inputs:
            targetType: 'inline'
            script: 'npm run build'

      - job: ArtifactPublish
        dependsOn: npmbuild
        displayName: Artifact publish
        steps:
        - task: PublishPipelineArtifact@1
          inputs:
            targetPath: '$(Pipeline.Workspace)'
            artifact: 'todo'
            publishLocation: 'pipeline'

# CD Part
  - stage: CD
    dependsOn: CI
    displayName: Deployment stage
    jobs:
      - job: artifactDownload
        displayName: Artifact Download
        steps:
        - task: DownloadPipelineArtifact@2
          inputs:
            buildType: 'current'
            artifactName: 'todo'
            targetPath: '$(Pipeline.Workspace)/todo'
        
      - job: copyOverSSH
        displayName: Copy over ssh
        dependsOn: artifactDownload
        steps:
        - task: CopyFilesOverSSH@0
          inputs:
            sshEndpoint: 'VMtodo'
            sourceFolder: '$(Pipeline.Workspace)/todo'
            contents: '**'
            targetFolder: '/home/rajat'
            readyTimeout: '20000'

      - job: sshthroughCopy
        displayName: copy artifact through ssh
        dependsOn: copyOverSSH
        steps:
        - task: SSH@0
          inputs:
            sshEndpoint: 'VMtodo'
            runOptions: 'commands'
            commands: 'sudo cp -r  /home/rajat/* var/www/html'
            readyTimeout: '20000'